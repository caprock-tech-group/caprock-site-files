<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Site Vulnerability Assessment Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- HTML2PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ops: {
                            bg: '#0c0a09',      // Stone 950
                            panel: '#1c1917',   // Stone 900
                            border: '#44403c',  // Stone 700
                            text: '#e7e5e4',    // Stone 200
                            mute: '#a8a29e',    // Stone 400
                            warn: '#f59e0b',    // Amber 500
                            crit: '#ef4444',    // Red 500
                            safe: '#10b981',    // Emerald 500
                            accent: '#3b82f6'   // Blue 500
                        }
                    },
                    fontFamily: {
                        mono: ['Courier Prime', 'monospace'],
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0c0a09;
            color: #e7e5e4;
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(rgba(28, 25, 23, 0.5) 1px, transparent 1px),
            linear-gradient(90deg, rgba(28, 25, 23, 0.5) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Custom Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 2px;
            background: #e7e5e4;
            border: 2px solid #ef4444; 
            cursor: pointer;
            margin-top: -10px; 
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #44403c;
            border-radius: 2px;
        }

        /* Checkbox Styling */
        .tac-checkbox { display: none; }
        .tac-checkbox + label {
            position: relative;
            padding-left: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            height: 100%;
            transition: all 0.2s;
        }
        .tac-checkbox + label:before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border: 2px solid #57534e;
            background: #1c1917;
            border-radius: 4px;
        }
        .tac-checkbox:checked + label:before {
            background: #ef4444;
            border-color: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.4);
        }
        .tac-checkbox:checked + label:after {
            content: '\f00d'; 
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 14px;
        }
        .tac-checkbox:checked + label { color: #ef4444; font-weight: bold; }

        /* Animations */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .animate-pulse-red { animation: pulse-red 2s infinite; }
        
        .active-tab {
            background-color: #292524;
            border-bottom: 2px solid #ef4444;
            color: white;
        }
        .inactive-tab {
            color: #78716c;
            border-bottom: 2px solid transparent;
        }

        /* PDF Template Styles (Scoped) */
        #pdf-template {
            background-color: white;
            color: #111827;
            font-family: 'Inter', sans-serif;
            width: 750px; /* Reduced width to prevent cutoff */
            padding: 40px;
            box-sizing: border-box; /* Ensure padding doesn't add to width */
        }
        .pdf-header { border-bottom: 2px solid #ef4444; padding-bottom: 10px; margin-bottom: 20px; }
        .pdf-section { margin-bottom: 25px; }
        .pdf-label { font-size: 10px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; font-weight: bold; }
        .pdf-value { font-size: 14px; font-weight: 600; color: #111827; }
        .pdf-box { border: 1px solid #e5e7eb; padding: 15px; border-radius: 4px; }
        .pdf-alert { background-color: #fef2f2; border: 1px solid #fca5a5; color: #991b1b; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen flex flex-col p-2 md:p-4 max-w-5xl mx-auto">

    <!-- TOP HEADER -->
    <header class="flex justify-between items-center bg-ops-panel border-b-2 border-ops-border p-4 rounded-t-lg mb-4 shadow-lg">
        <div>
            <div class="text-xs text-ops-warn font-mono tracking-widest uppercase mb-1">
                <i class="fas fa-shield-alt mr-1"></i> Caprock Security Logic
            </div>
            <h1 class="text-xl md:text-2xl font-bold uppercase tracking-tight">Site Vulnerability Assessment</h1>
        </div>
        <div class="text-right hidden md:block">
            <div class="text-xs text-ops-mute font-mono">AUDIT DATE</div>
            <div class="text-sm font-mono text-ops-accent" id="current-date">--/--/----</div>
        </div>
    </header>

    <!-- MAIN GRID -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 flex-grow">
        
        <!-- LEFT COLUMN: AUDIT INPUTS -->
        <div class="lg:col-span-2 flex flex-col gap-4">
            
            <!-- TABS -->
            <div class="grid grid-cols-3 bg-ops-panel rounded border border-ops-border overflow-hidden">
                <button onclick="switchTab('perimeter')" id="tab-perimeter" class="active-tab py-4 font-bold uppercase tracking-wide text-sm transition-colors">
                    <i class="fas fa-crop-alt mr-2"></i> Perimeter
                </button>
                <button onclick="switchTab('assets')" id="tab-assets" class="inactive-tab py-4 font-bold uppercase tracking-wide text-sm transition-colors">
                    <i class="fas fa-cubes mr-2"></i> Assets
                </button>
                <button onclick="switchTab('threat')" id="tab-threat" class="inactive-tab py-4 font-bold uppercase tracking-wide text-sm transition-colors">
                    <i class="fas fa-biohazard mr-2"></i> Threat Env
                </button>
            </div>

            <!-- TAB CONTENT CONTAINER -->
            <div class="bg-ops-panel border border-ops-border rounded p-6 flex-grow relative min-h-[400px]">
                
                <!-- PERIMETER TAB -->
                <div id="content-perimeter" class="tab-content space-y-6">
                    <div class="flex justify-between items-center border-b border-ops-border pb-2 mb-4">
                        <h3 class="text-ops-mute uppercase font-mono text-sm tracking-widest">Zone 1: Perimeter Integrity</h3>
                        <span class="bg-ops-bg px-2 py-1 rounded text-xs text-ops-warn font-mono">CHECK IF VULNERABLE</span>
                    </div>
                    <div class="space-y-4">
                        <div class="h-14 bg-ops-bg rounded border border-ops-border flex items-center px-4 hover:border-ops-mute transition">
                            <input type="checkbox" id="p-fencing" class="tac-checkbox" onchange="calculateScore()">
                            <label for="p-fencing">Perimeter Fencing Compromised / Incomplete</label>
                        </div>
                        <div class="h-14 bg-ops-bg rounded border border-ops-border flex items-center px-4 hover:border-ops-mute transition">
                            <input type="checkbox" id="p-lighting" class="tac-checkbox" onchange="calculateScore()">
                            <label for="p-lighting">Inadequate Lighting / Dark Zones</label>
                        </div>
                        <div class="h-14 bg-ops-bg rounded border border-ops-border flex items-center px-4 hover:border-ops-mute transition">
                            <input type="checkbox" id="p-blindspots" class="tac-checkbox" onchange="calculateScore()">
                            <label for="p-blindspots">Significant Blind Spots from Road</label>
                        </div>
                        <div class="h-14 bg-ops-bg rounded border border-ops-border flex items-center px-4 hover:border-ops-mute transition">
                            <input type="checkbox" id="p-gate" class="tac-checkbox" onchange="calculateScore()">
                            <label for="p-gate">Open Gate / Unsecured Access Points</label>
                        </div>
                    </div>
                </div>

                <!-- ASSETS TAB -->
                <div id="content-assets" class="tab-content space-y-6 hidden">
                    <div class="flex justify-between items-center border-b border-ops-border pb-2 mb-4">
                        <h3 class="text-ops-mute uppercase font-mono text-sm tracking-widest">Zone 2: Asset Exposure</h3>
                        <span class="bg-ops-bg px-2 py-1 rounded text-xs text-ops-warn font-mono">CHECK IF EXPOSED</span>
                    </div>
                    <div class="space-y-4">
                        <div class="h-14 bg-ops-bg rounded border border-ops-border flex items-center px-4 hover:border-ops-mute transition">
                            <input type="checkbox" id="a-copper" class="tac-checkbox" onchange="calculateScore()">
                            <label for="a-copper">Copper / Wiring / HVAC Units (High Target)</label>
                        </div>
                        <div class="h-14 bg-ops-bg rounded border border-ops-border flex items-center px-4 hover:border-ops-mute transition">
                            <input type="checkbox" id="a-equipment" class="tac-checkbox" onchange="calculateScore()">
                            <label for="a-equipment">Heavy Equipment (Keys on site/Accessible)</label>
                        </div>
                        <div class="h-14 bg-ops-bg rounded border border-ops-border flex items-center px-4 hover:border-ops-mute transition">
                            <input type="checkbox" id="a-materials" class="tac-checkbox" onchange="calculateScore()">
                            <label for="a-materials">Lumber / Building Materials Unsecured</label>
                        </div>
                        <div class="h-14 bg-ops-bg rounded border border-ops-border flex items-center px-4 hover:border-ops-mute transition">
                            <input type="checkbox" id="a-tools" class="tac-checkbox" onchange="calculateScore()">
                            <label for="a-tools">Tool Storage / Conex Boxes (Vulnerable Locks)</label>
                        </div>
                    </div>
                </div>

                <!-- THREAT ENV TAB -->
                <div id="content-threat" class="tab-content space-y-6 hidden">
                    <div class="flex justify-between items-center border-b border-ops-border pb-2 mb-4">
                        <h3 class="text-ops-mute uppercase font-mono text-sm tracking-widest">Zone 3: External Factors</h3>
                        <span class="bg-ops-bg px-2 py-1 rounded text-xs text-ops-crit font-mono">CRITICAL FACTORS</span>
                    </div>
                    
                    <div class="p-4 bg-ops-bg rounded border border-ops-border">
                        <label class="block text-sm font-bold mb-4 flex justify-between">
                            <span>Neighborhood Crime Activity</span>
                            <span id="crime-val" class="text-ops-warn font-mono">MODERATE</span>
                        </label>
                        <input type="range" id="t-crime" min="0" max="10" step="1" value="5" class="w-full" oninput="calculateScore()">
                        <div class="flex justify-between text-xs text-ops-mute mt-2 font-mono">
                            <span>LOW</span>
                            <span>HIGH</span>
                        </div>
                    </div>

                    <div class="h-14 bg-ops-bg rounded border border-ops-border flex items-center px-4 hover:border-ops-mute transition">
                        <input type="checkbox" id="t-history" class="tac-checkbox" onchange="calculateScore()">
                        <label for="t-history">Site has history of previous theft/vandalism</label>
                    </div>

                    <div class="p-4 bg-ops-bg rounded border border-ops-crit border-l-4">
                        <label class="block text-sm font-bold mb-4 flex justify-between items-center">
                            <span class="text-ops-crit uppercase"><i class="fas fa-exclamation-triangle mr-2"></i>Police Response Estimate</span>
                            <span id="response-val" class="text-ops-crit font-mono text-lg font-bold">15 MIN</span>
                        </label>
                        <input type="range" id="t-response" min="5" max="60" step="5" value="15" class="w-full" oninput="calculateScore()">
                        <div class="flex justify-between text-xs text-ops-mute mt-2 font-mono">
                            <span>5 MIN</span>
                            <span>60+ MIN</span>
                        </div>
                        <p class="text-xs text-ops-mute mt-3 italic border-t border-ops-border pt-2">
                            <i class="fas fa-info-circle mr-1"></i> Impact: High response times drastically increase vulnerability window.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: SCORE & CALCULATOR -->
        <div class="flex flex-col gap-4">
            
            <!-- VULNERABILITY SCORE CARD -->
            <div class="bg-ops-panel border border-ops-border rounded p-6 flex flex-col items-center justify-center text-center relative overflow-hidden">
                <div id="score-pulse" class="absolute inset-0 bg-ops-crit opacity-0 transition-opacity duration-500"></div>
                <h2 class="text-ops-mute font-mono text-xs uppercase tracking-widest z-10 mb-2">Total Vulnerability Score</h2>
                <div class="relative z-10">
                    <span id="score-display" class="text-6xl font-black text-ops-safe transition-colors duration-500">0%</span>
                </div>
                <div id="risk-label" class="mt-2 px-3 py-1 bg-ops-bg rounded border border-ops-border text-xs font-mono text-ops-safe z-10">
                    LOW RISK
                </div>
            </div>

            <!-- COST OF INACTION CALCULATOR -->
            <div class="bg-ops-panel border border-ops-border rounded p-6">
                <h3 class="text-ops-mute font-mono text-xs uppercase tracking-widest mb-4 border-b border-ops-border pb-2">
                    Cost of Inaction Calculator
                </h3>
                <div class="mb-4">
                    <label class="block text-xs font-bold mb-1">Total Asset Value on Site ($)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2.5 text-ops-mute">$</span>
                        <input type="number" id="asset-value" class="w-full bg-ops-bg border border-ops-border rounded p-2 pl-6 text-white focus:border-ops-accent outline-none font-mono" placeholder="e.g. 500000" oninput="calculateScore()">
                    </div>
                </div>
                <div class="bg-ops-bg p-4 rounded border border-ops-border">
                    <div class="text-xs text-ops-mute mb-1">ESTIMATED EXPOSURE (QTR)</div>
                    <div id="exposure-display" class="text-2xl font-bold text-white font-mono">$0</div>
                </div>
            </div>

            <!-- ACTION BUTTONS -->
            <div class="flex-grow flex flex-col justify-end gap-3">
                 <!-- SOLUTION BRIDGE -->
                <div id="solution-card" class="hidden bg-stone-800 border-l-4 border-ops-accent p-4 rounded shadow-lg animate-pulse-red">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="text-ops-accent font-bold uppercase text-sm"><i class="fas fa-crosshairs mr-2"></i>Countermeasure</h4>
                        <span class="text-[10px] bg-ops-accent text-black px-1 rounded font-bold">RECOMMENDED</span>
                    </div>
                    <p class="text-xs text-stone-300 mb-2">Risk level requires Active Deterrence.</p>
                    <div class="text-xs font-mono text-white">HARDWARE: <span class="text-ops-warn">Montavue Sentry Unit</span></div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="generateReport()" class="bg-stone-800 hover:bg-stone-700 text-ops-mute hover:text-white font-bold py-3 rounded border border-ops-border uppercase text-xs tracking-widest transition-all">
                        <i class="fas fa-terminal mr-2"></i> View Text
                    </button>
                    <button onclick="downloadPDF()" class="bg-ops-accent hover:bg-blue-600 text-white font-bold py-3 rounded border border-blue-400 uppercase text-xs tracking-widest transition-all shadow-lg active:scale-95">
                        <i class="fas fa-file-pdf mr-2"></i> Export PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- HIDDEN REPORT MODAL (Appears on Text Generation) -->
    <div id="report-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-ops-panel border-2 border-ops-accent w-full max-w-2xl rounded shadow-2xl flex flex-col max-h-[90vh]">
            <div class="bg-stone-800 p-4 border-b border-ops-border flex justify-between items-center">
                <h3 class="text-ops-accent font-mono font-bold uppercase"><i class="fas fa-terminal mr-2"></i>Raw Intel Report</h3>
                <button onclick="closeReport()" class="text-ops-mute hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto bg-black font-mono text-sm text-green-500 leading-relaxed" id="report-text"></div>
            <div class="p-4 border-t border-ops-border bg-stone-800 flex justify-end gap-3">
                <button onclick="closeReport()" class="px-4 py-2 text-ops-mute hover:text-white text-sm font-bold uppercase">Close</button>
                <button onclick="copyToClipboard()" class="bg-ops-accent hover:bg-blue-600 text-white px-6 py-2 rounded font-bold uppercase tracking-wide shadow-lg">
                    <i class="fas fa-copy mr-2"></i> Copy
                </button>
            </div>
        </div>
    </div>

    <!-- HIDDEN PDF TEMPLATE (Used for Generation) -->
    <div style="display:none;">
        <div id="pdf-template">
            <!-- Header -->
            <div class="flex justify-between items-end pdf-header">
                <div>
                    <h1 class="text-2xl font-black text-gray-900 uppercase tracking-tighter">Site Intelligence Report</h1>
                    <p class="text-xs text-gray-500 font-mono">PREPARED BY: CAPROCK TECHNOLOGY GROUP</p>
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-400 font-bold uppercase">Generated On</div>
                    <div class="font-mono font-bold text-gray-800" id="pdf-date">10/12/2023</div>
                </div>
            </div>

            <!-- Executive Summary -->
            <div class="grid grid-cols-2 gap-6 pdf-section">
                <div class="pdf-box bg-gray-50">
                    <div class="pdf-label">Risk Assessment</div>
                    <div class="flex items-center mt-2">
                        <div class="text-4xl font-black mr-3" id="pdf-score">85%</div>
                        <div id="pdf-risk-label" class="px-2 py-1 text-xs font-bold text-white bg-red-600 rounded uppercase">Critical</div>
                    </div>
                </div>
                <div class="pdf-box bg-gray-50">
                    <div class="pdf-label">Est. Quarterly Exposure</div>
                    <div class="text-3xl font-bold text-gray-900 mt-2 font-mono" id="pdf-exposure">$42,500</div>
                    <div class="text-xs text-gray-400 mt-1">Based on Asset Value & Risk Factor</div>
                </div>
            </div>

            <!-- Threat Analysis -->
            <div class="pdf-section">
                <h3 class="text-sm font-bold text-gray-900 uppercase border-b border-gray-200 pb-1 mb-3">Threat Environment</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <div class="pdf-label">Police Response</div>
                        <div class="pdf-value" id="pdf-response">15 MIN</div>
                    </div>
                    <div>
                        <div class="pdf-label">Crime Index</div>
                        <div class="pdf-value" id="pdf-crime">MODERATE</div>
                    </div>
                    <div>
                        <div class="pdf-label">History</div>
                        <div class="pdf-value" id="pdf-history">None</div>
                    </div>
                </div>
            </div>

            <!-- Vulnerabilities -->
            <div class="pdf-section">
                <h3 class="text-sm font-bold text-gray-900 uppercase border-b border-gray-200 pb-1 mb-3">Identified Vulnerabilities</h3>
                <ul class="list-disc list-inside text-sm text-gray-700 space-y-1" id="pdf-vulns">
                    <!-- Injected via JS -->
                </ul>
            </div>

            <!-- Recommendation -->
            <div class="pdf-alert mt-6">
                <div class="flex items-start">
                    <div class="mr-4 text-2xl"><i class="fas fa-shield-alt"></i></div>
                    <div>
                        <h4 class="font-bold uppercase text-xs tracking-wider mb-1">Recommended Countermeasure</h4>
                        <div class="font-bold text-lg text-gray-900">Montavue Autonomous Sentry Deployment</div>
                        <p class="text-xs text-gray-700 mt-1" id="pdf-recommendation">
                            Risk score indicates passive measures are insufficient. Active deterrence required to mitigate police response latency.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Contact & Footer -->
             <div class="mt-8 p-4 bg-gray-100 rounded border border-gray-200 text-center">
                <h4 class="text-xs font-bold text-gray-500 uppercase mb-1">For Immediate Remediation Support</h4>
                <div class="text-lg font-bold text-gray-900">Caprock Technology Group</div>
                <div class="text-xl font-black text-blue-600 mt-1">806-316-5070</div>
            </div>

            <div class="mt-8 pt-4 border-t border-gray-200 flex justify-between items-center text-[10px] text-gray-400 uppercase font-mono">
                <div>Confidential - For Client Use Only</div>
                <div>Page 1 of 1</div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const today = new Date().toLocaleDateString();
        document.getElementById('current-date').innerText = today;
        document.getElementById('pdf-date').innerText = today;

        // --- TAB LOGIC ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('button[id^="tab-"]').forEach(btn => {
                btn.classList.remove('active-tab');
                btn.classList.add('inactive-tab');
            });
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tab-${tabId}`);
            activeBtn.classList.remove('inactive-tab');
            activeBtn.classList.add('active-tab');
        }

        // --- SCORING ENGINE ---
        function calculateScore() {
            let rawScore = 0;
            const checks = document.querySelectorAll('.tac-checkbox:checked');
            rawScore += checks.length * 8; 

            const crimeVal = parseInt(document.getElementById('t-crime').value);
            const crimeMultiplier = 1 + (crimeVal / 20);
            
            const crimeLabel = document.getElementById('crime-val');
            if(crimeVal < 4) { crimeLabel.innerText = "LOW"; crimeLabel.className = "text-ops-safe font-mono"; }
            else if(crimeVal < 7) { crimeLabel.innerText = "MODERATE"; crimeLabel.className = "text-ops-warn font-mono"; }
            else { crimeLabel.innerText = "HIGH"; crimeLabel.className = "text-ops-crit font-mono"; }

            const responseTime = parseInt(document.getElementById('t-response').value);
            document.getElementById('response-val').innerText = responseTime + (responseTime >= 60 ? "+ MIN" : " MIN");
            
            let responsePenalty = 0;
            if (responseTime > 15) responsePenalty += 10;
            if (responseTime > 30) responsePenalty += 20;
            if (responseTime > 45) responsePenalty += 40;

            let finalScore = (rawScore + responsePenalty) * crimeMultiplier;
            if(finalScore > 100) finalScore = 100;
            finalScore = Math.round(finalScore);

            updateUI(finalScore);
            saveState();
        }

        function updateUI(score) {
            const scoreDisplay = document.getElementById('score-display');
            const riskLabel = document.getElementById('risk-label');
            const pulse = document.getElementById('score-pulse');
            const solutionCard = document.getElementById('solution-card');

            scoreDisplay.innerText = score + "%";

            if(score < 30) {
                scoreDisplay.className = "text-6xl font-black text-ops-safe transition-colors duration-500";
                riskLabel.innerText = "LOW RISK";
                riskLabel.className = "mt-2 px-3 py-1 bg-ops-bg rounded border border-ops-border text-xs font-mono text-ops-safe z-10";
                pulse.style.opacity = 0;
                solutionCard.classList.add('hidden');
            } else if (score < 60) {
                scoreDisplay.className = "text-6xl font-black text-ops-warn transition-colors duration-500";
                riskLabel.innerText = "ELEVATED RISK";
                riskLabel.className = "mt-2 px-3 py-1 bg-ops-bg rounded border border-ops-border text-xs font-mono text-ops-warn z-10";
                pulse.style.opacity = 0;
                solutionCard.classList.add('hidden');
            } else {
                scoreDisplay.className = "text-6xl font-black text-ops-crit transition-colors duration-500";
                riskLabel.innerText = "CRITICAL RISK";
                riskLabel.className = "mt-2 px-3 py-1 bg-ops-bg rounded border border-ops-border text-xs font-mono text-ops-crit z-10";
                pulse.className = "absolute inset-0 bg-ops-crit opacity-10 animate-pulse-red";
                pulse.style.opacity = 0.2;
                solutionCard.classList.remove('hidden');
            }

            const assetVal = document.getElementById('asset-value').value;
            if(assetVal) {
                const exposure = Math.round(assetVal * (score / 100) * 0.15);
                document.getElementById('exposure-display').innerText = "$" + exposure.toLocaleString();
                if(exposure > 10000) document.getElementById('exposure-display').classList.add('text-ops-crit');
                else document.getElementById('exposure-display').classList.remove('text-ops-crit');
            }
        }

        // --- REPORT GENERATOR (TEXT) ---
        function generateReport() {
            const score = document.getElementById('score-display').innerText;
            const riskLabel = document.getElementById('risk-label').innerText;
            const exposure = document.getElementById('exposure-display').innerText;
            const responseTime = document.getElementById('t-response').value;
            
            let vulns = [];
            document.querySelectorAll('.tac-checkbox:checked').forEach(box => {
                vulns.push("- " + document.querySelector(`label[for="${box.id}"]`).innerText);
            });
            
            if(parseInt(responseTime) > 30) {
                vulns.push(`- CRITICAL: Police Response Time Estimate (${responseTime} min) creates excessive vulnerability window.`);
            }
            if(vulns.length === 0) vulns.push("- No major physical vulnerabilities flagged.");

            let recommendation = "";
            if(parseInt(score) > 50) {
                recommendation = `
RECOMMENDED COUNTERMEASURE:
Deployment of Montavue Autonomous Sentry Unit.
Reasoning: Risk Score (${score}) indicates standard passive measures are insufficient against estimated threat level.
Immediate ROI: Active Deterrence (Sirens/Strobes) mitigates the ${responseTime} min police delay.`;
            } else {
                recommendation = `RECOMMENDED COUNTERMEASURE: Maintain current passive protocols. Re-evaluate quarterly.`;
            }

            const reportContent = `
[SITE SECURITY AUDIT - SUMMARY]
DATE: ${today}
PREPARED BY: CAPROCK TECHNOLOGY GROUP
CONTACT: 806-316-5070

RISK LEVEL: ${riskLabel} (${score})
ESTIMATED EXPOSURE (QTR): ${exposure}

MAJOR VULNERABILITIES DETECTED:
${vulns.join('\n')}
${recommendation}
            `.trim();

            document.getElementById('report-text').innerText = reportContent;
            document.getElementById('report-modal').classList.remove('hidden');
        }

        // --- PDF DOWNLOAD ENGINE ---
        function downloadPDF() {
            // 1. Gather Data
            const score = document.getElementById('score-display').innerText;
            const riskLabel = document.getElementById('risk-label').innerText;
            const exposure = document.getElementById('exposure-display').innerText;
            const responseTime = document.getElementById('t-response').value;
            const crimeVal = document.getElementById('crime-val').innerText;
            const history = document.getElementById('t-history').checked ? "YES" : "NO";

            // 2. Populate PDF Template
            document.getElementById('pdf-score').innerText = score;
            const pdfLabel = document.getElementById('pdf-risk-label');
            pdfLabel.innerText = riskLabel;
            
            // Style label based on risk
            if(riskLabel.includes("LOW")) pdfLabel.className = "px-2 py-1 text-xs font-bold text-white bg-green-500 rounded uppercase";
            else if(riskLabel.includes("ELEVATED")) pdfLabel.className = "px-2 py-1 text-xs font-bold text-white bg-amber-500 rounded uppercase";
            else pdfLabel.className = "px-2 py-1 text-xs font-bold text-white bg-red-600 rounded uppercase";

            document.getElementById('pdf-exposure').innerText = exposure;
            document.getElementById('pdf-response').innerText = responseTime + " MIN";
            document.getElementById('pdf-crime').innerText = crimeVal;
            document.getElementById('pdf-history').innerText = history;

            const vulnList = document.getElementById('pdf-vulns');
            vulnList.innerHTML = '';
            document.querySelectorAll('.tac-checkbox:checked').forEach(box => {
                const li = document.createElement('li');
                li.innerText = document.querySelector(`label[for="${box.id}"]`).innerText;
                vulnList.appendChild(li);
            });
            if(parseInt(responseTime) > 30) {
                 const li = document.createElement('li');
                 li.innerHTML = `<strong>CRITICAL:</strong> ${responseTime} min Police Response creates high-risk window.`;
                 li.style.color = '#dc2626';
                 vulnList.appendChild(li);
            }
            if(vulnList.children.length === 0) {
                vulnList.innerHTML = '<li>No critical vulnerabilities identified.</li>';
            }

            // Recommendation Logic for PDF
            const recText = document.getElementById('pdf-recommendation');
            if(parseInt(score) > 50) {
                recText.innerHTML = `Risk Score <strong>(${score})</strong> indicates standard passive measures are insufficient. <br>Active deterrence required to mitigate police response latency of ${responseTime} mins.`;
            } else {
                recText.innerHTML = "Current passive protocols appear adequate. Recommend re-evaluation in 90 days.";
            }

            // 3. Generate PDF
            const element = document.getElementById('pdf-template');
            const opt = {
                margin:       0.5,
                filename:     `Site_Audit_${today.replace(/\//g,'-')}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            // Use html2pdf to save
            html2pdf().set(opt).from(element).save();
        }

        function closeReport() {
            document.getElementById('report-modal').classList.add('hidden');
        }

        function copyToClipboard() {
            const text = document.getElementById('report-text').innerText;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('#report-modal button i.fa-copy').parentElement;
                btn.innerHTML = '<i class="fas fa-check mr-2"></i> Copied!';
                btn.classList.replace('bg-ops-accent', 'bg-ops-safe');
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-copy mr-2"></i> Copy';
                    btn.classList.replace('bg-ops-safe', 'bg-ops-accent');
                }, 2000);
            });
        }

        // --- PERSISTENCE ---
        function saveState() {
            const state = {
                checks: Array.from(document.querySelectorAll('.tac-checkbox')).map(c => ({id: c.id, checked: c.checked})),
                crime: document.getElementById('t-crime').value,
                response: document.getElementById('t-response').value,
                assets: document.getElementById('asset-value').value
            };
            localStorage.setItem('caprock_audit_data', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('caprock_audit_data');
            if(saved) {
                const state = JSON.parse(saved);
                state.checks.forEach(item => {
                    const el = document.getElementById(item.id);
                    if(el) el.checked = item.checked;
                });
                if(state.crime) document.getElementById('t-crime').value = state.crime;
                if(state.response) document.getElementById('t-response').value = state.response;
                if(state.assets) document.getElementById('asset-value').value = state.assets;
                calculateScore();
            }
        }

        window.onload = loadState;
    </script>
</body>
</html>
